<!-- ==================== views/rh/dashboard.ejs ==================== -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord RH - Lab Personnel Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root {
            --purple: #6c5b7b;
            --teal: #00bfa5;
            --olive: #8b9556;
            --orange: #ff7043;
            --sidebar-width: 260px;
        }

        body {
            background-color: #f8f9fa;
            overflow-x: hidden;
        }

        /* Layout avec sidebar fixe */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
            min-height: 100vh;
        }

        /* Page Header */
        .page-header {
            background: linear-gradient(135deg, var(--purple) 0%, var(--teal) 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(108, 91, 123, 0.2);
        }

        .page-header h2 {
            font-weight: 600;
            margin: 0;
        }

        .page-header .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 8px;
        }

        /* Stats Cards */
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid #e9ecef;
            height: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-color: var(--purple);
        }

        .stat-card.primary { border-left: 4px solid #0d6efd; }
        .stat-card.success { border-left: 4px solid #198754; }
        .stat-card.info { border-left: 4px solid #0dcaf0; }
        .stat-card.warning { border-left: 4px solid #ffc107; }
        .stat-card.danger { border-left: 4px solid #dc3545; }
        .stat-card.secondary { border-left: 4px solid #6c757d; }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .stat-icon.primary { color: #0d6efd; }
        .stat-icon.success { color: #198754; }
        .stat-icon.info { color: #0dcaf0; }
        .stat-icon.warning { color: #ffc107; }
        .stat-icon.danger { color: #dc3545; }
        .stat-icon.secondary { color: #6c757d; }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #212529;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 13px;
            color: #6c757d;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Process Steps */
        .process-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .process-header {
            background: linear-gradient(135deg, var(--purple) 0%, var(--teal) 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            margin: -30px -30px 30px -30px;
        }

        .process-steps {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .process-step {
            flex: 1;
            min-width: 200px;
            text-align: center;
            padding: 25px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            position: relative;
            transition: all 0.3s ease;
        }

        .process-step:hover {
            border-color: var(--purple);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(108, 91, 123, 0.15);
        }

        .process-step::after {
            content: '→';
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2rem;
            color: var(--purple);
            z-index: 1;
        }

        .process-step:last-child::after {
            display: none;
        }

        .process-icon {
            font-size: 3rem;
            color: var(--purple);
            margin-bottom: 15px;
        }

        .process-step h5 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #212529;
        }

        .process-step p {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .process-step .btn {
            font-size: 13px;
        }

        /* Cards */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .card-header {
            border-radius: 12px 12px 0 0 !important;
            padding: 20px;
            font-weight: 600;
        }

        .card-header h5 {
            margin: 0;
        }

        /* Accordion */
        .accordion {
            --bs-accordion-border-radius: 12px;
        }

        .accordion-item {
            border: 1px solid #e9ecef;
            margin-bottom: 10px;
            border-radius: 8px !important;
            overflow: hidden;
        }

        .accordion-button {
            font-weight: 600;
            background-color: #f8f9fa;
        }

        .accordion-button:not(.collapsed) {
            background: linear-gradient(135deg, var(--purple) 0%, var(--teal) 100%);
            color: white;
        }

        .accordion-button:focus {
            box-shadow: none;
        }

        /* Quick Actions */
        .quick-action-btn {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            border: 2px solid;
            margin-bottom: 10px;
        }

        .quick-action-btn:hover {
            transform: translateX(5px);
        }

        .quick-action-btn i {
            font-size: 20px;
            margin-right: 12px;
        }

        /* Alerts */
        .alert {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            margin-bottom: 15px;
        }

        .alert-link {
            text-decoration: none;
            font-weight: 600;
        }

        .alert-link:hover {
            text-decoration: underline;
        }

        /* ISO Badge */
        .iso-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 15px;
            }

            .process-steps {
                flex-direction: column;
            }

            .process-step::after {
                display: none;
            }

            .page-header {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <%- include('../partials/sidebar', { currentPage: 'rh-dashboard' }) %>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h2>
                        <i class="bi bi-diagram-3 me-2"></i>
                        Tableau de Bord RH
                        <span class="iso-badge">ISO 15189:2022 - Section 5.1</span>
                    </h2>
                    <div class="subtitle">
                        <i class="bi bi-shield-check me-1"></i>
                        Gestion des Ressources Humaines conformément aux normes NF EN ISO 15189 et ISO 22870
                    </div>
                </div>
                <div class="text-end">
                    <div class="text-white" style="font-size: 14px;">
                        <i class="bi bi-calendar3 me-1"></i>
                        <%= new Date().toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' }) %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="stat-card primary">
                    <div class="stat-icon primary">
                        <i class="bi bi-briefcase-fill"></i>
                    </div>
                    <div class="stat-value"><%= typeof stats !== 'undefined' ? stats.total_postes : 0 %></div>
                    <div class="stat-label">Postes Actifs</div>
                </div>
            </div>

            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="stat-card success">
                    <div class="stat-icon success">
                        <i class="bi bi-mortarboard-fill"></i>
                    </div>
                    <div class="stat-value"><%= typeof stats !== 'undefined' ? stats.formations_actives : 0 %></div>
                    <div class="stat-label">Formations Actives</div>
                </div>
            </div>

            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="stat-card info">
                    <div class="stat-icon info">
                        <i class="bi bi-award-fill"></i>
                    </div>
                    <div class="stat-value"><%= typeof stats !== 'undefined' ? stats.habilitations_actives : 0 %></div>
                    <div class="stat-label">Habilitations</div>
                </div>
            </div>

            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="stat-card warning">
                    <div class="stat-icon warning">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    </div>
                    <div class="stat-value"><%= typeof stats !== 'undefined' ? stats.habilitations_a_renouveler : 0 %></div>
                    <div class="stat-label">À Renouveler</div>
                </div>
            </div>

            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="stat-card danger">
                    <div class="stat-icon danger">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="stat-value"><%= typeof stats !== 'undefined' ? stats.recrutements_ouverts : 0 %></div>
                    <div class="stat-label">Recrutements</div>
                </div>
            </div>

            <div class="col-xl-2 col-lg-4 col-md-6">
                <div class="stat-card secondary">
                    <div class="stat-icon secondary">
                        <i class="bi bi-clipboard-check-fill"></i>
                    </div>
                    <div class="stat-value"><%= typeof stats !== 'undefined' ? stats.besoins_en_attente : 0 %></div>
                    <div class="stat-label">Besoins Formation</div>
                </div>
            </div>
        </div>

        <!-- Processus RH -->
        <div class="process-section">
            <div class="process-header">
                <h5 class="mb-0">
                    <i class="bi bi-diagram-3 me-2"></i>
                    Processus Ressources Humaines
                </h5>
            </div>

            <!-- Process Steps -->
            <div class="process-steps">
                <div class="process-step">
                    <div class="process-icon">
                        <i class="bi bi-person-plus-fill"></i>
                    </div>
                    <h5>1. Recrutement</h5>
                    <p>Identification des besoins et sélection</p>
                    <a href="/rh/recrutements" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-right me-1"></i> Gérer
                    </a>
                </div>

                <div class="process-step">
                    <div class="process-icon">
                        <i class="bi bi-book-fill"></i>
                    </div>
                    <h5>2. Formation</h5>
                    <p>Programmes & Évaluations</p>
                    <a href="/rh/formations" class="btn btn-sm btn-outline-success">
                        <i class="bi bi-arrow-right me-1"></i> Gérer
                    </a>
                </div>

                <div class="process-step">
                    <div class="process-icon">
                        <i class="bi bi-patch-check-fill"></i>
                    </div>
                    <h5>3. Habilitation</h5>
                    <p>Maintien des compétences</p>
                    <a href="/rh/habilitations" class="btn btn-sm btn-outline-info">
                        <i class="bi bi-arrow-right me-1"></i> Gérer
                    </a>
                </div>

                <div class="process-step">
                    <div class="process-icon">
                        <i class="bi bi-clipboard-data-fill"></i>
                    </div>
                    <h5>4. Évaluation</h5>
                    <p>Personnel compétent</p>
                    <a href="/rh/evaluations" class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-arrow-right me-1"></i> Gérer
                    </a>
                </div>
            </div>

            <!-- Détails des processus -->
            <div class="accordion" id="processusAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#recrutement">
                            <i class="bi bi-1-circle me-2"></i> Processus Recrutement
                        </button>
                    </h2>
                    <div id="recrutement" class="accordion-collapse collapse show" data-bs-parent="#processusAccordion">
                        <div class="accordion-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="bi bi-people me-2 text-primary"></i>Responsables</h6>
                                    <p class="text-muted">Biologiste, Cadre de pôle, Cadre de santé, DCGS, DRH</p>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="bi bi-file-text me-2 text-success"></i>Documents</h6>
                                    <p class="text-muted">Procédure gestion personnel (RESS_PR_01)</p>
                                </div>
                            </div>
                            <h6><i class="bi bi-check-circle me-2 text-info"></i>Validation</h6>
                            <p class="text-muted">DCGS et DRH avec signature du contrat</p>
                            <a href="/rh/recrutements" class="btn btn-primary btn-sm">
                                <i class="bi bi-arrow-right me-1"></i> Accéder aux recrutements
                            </a>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#formation">
                            <i class="bi bi-2-circle me-2"></i> Processus Formation
                        </button>
                    </h2>
                    <div id="formation" class="accordion-collapse collapse" data-bs-parent="#processusAccordion">
                        <div class="accordion-body">
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="bi bi-check2 text-success me-2"></i><strong>Programme d'intégration:</strong> Livret d'accueil (RESS_MO_01)</li>
                                <li class="mb-2"><i class="bi bi-check2 text-success me-2"></i><strong>Évaluation:</strong> Formulaire (RESS_FO_01)</li>
                                <li class="mb-2"><i class="bi bi-check2 text-success me-2"></i><strong>Plan annuel:</strong> Basé sur évaluations et besoins</li>
                            </ul>
                            <div class="btn-group">
                                <a href="/rh/formations" class="btn btn-success btn-sm">
                                    <i class="bi bi-mortarboard me-1"></i> Formations
                                </a>
                                <a href="/rh/besoins-formation" class="btn btn-outline-success btn-sm">
                                    <i class="bi bi-clipboard me-1"></i> Besoins
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#habilitation">
                            <i class="bi bi-3-circle me-2"></i> Processus Habilitation et Compétences
                        </button>
                    </h2>
                    <div id="habilitation" class="accordion-collapse collapse" data-bs-parent="#processusAccordion">
                        <div class="accordion-body">
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="bi bi-check2 text-info me-2"></i><strong>Fiches de postes:</strong> Description complète dans Sapanet</li>
                                <li class="mb-2"><i class="bi bi-check2 text-info me-2"></i><strong>Habilitations:</strong> Formulaires par poste avec codification</li>
                                <li class="mb-2"><i class="bi bi-check2 text-info me-2"></i><strong>Cartographie:</strong> Habilitations techniciens (RESS_LI_04)</li>
                                <li class="mb-2"><i class="bi bi-check2 text-info me-2"></i><strong>Confidentialité:</strong> Engagement (QUAL_FO_02)</li>
                            </ul>
                            <a href="/rh/habilitations" class="btn btn-info btn-sm">
                                <i class="bi bi-arrow-right me-1"></i> Accéder aux habilitations
                            </a>
                        </div>
                    </div>
                </div>

                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#evaluation">
                            <i class="bi bi-4-circle me-2"></i> Processus Évaluation
                        </button>
                    </h2>
                    <div id="evaluation" class="accordion-collapse collapse" data-bs-parent="#processusAccordion">
                        <div class="accordion-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="bi bi-people me-2 text-warning"></i>Évaluateurs</h6>
                                    <p class="text-muted">Cadre de santé, Biologiste</p>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="bi bi-calendar me-2 text-warning"></i>Fréquence</h6>
                                    <p class="text-muted">Une fois par an</p>
                                </div>
                            </div>
                            <h6><i class="bi bi-target me-2 text-danger"></i>Indicateurs</h6>
                            <p class="text-muted">Nombre de postes occupés par personne non habilitée</p>
                            <a href="/rh/evaluations" class="btn btn-warning btn-sm">
                                <i class="bi bi-arrow-right me-1"></i> Accéder aux évaluations
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions & Alertes -->
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-lightning-charge me-2"></i>Actions Rapides</h5>
                    </div>
                    <div class="card-body">
                        <a href="/rh/departements" class="quick-action-btn btn-outline-primary">
                            <i class="bi bi-building"></i>
                            <span>Gérer les Départements</span>
                        </a>
                        <a href="/rh/postes" class="quick-action-btn btn-outline-primary">
                            <i class="bi bi-briefcase"></i>
                            <span>Gérer les Postes</span>
                        </a>
                        <a href="/rh/formations/add" class="quick-action-btn btn-outline-success">
                            <i class="bi bi-plus-circle"></i>
                            <span>Créer une Formation</span>
                        </a>
                        <a href="/rh/habilitations/add" class="quick-action-btn btn-outline-info">
                            <i class="bi bi-award"></i>
                            <span>Ajouter une Habilitation</span>
                        </a>
                        <a href="/rh/competences" class="quick-action-btn btn-outline-secondary">
                            <i class="bi bi-star"></i>
                            <span>Référentiel Compétences</span>
                        </a>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card border-warning">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Alertes & Actions Requises
                        </h5>
                    </div>
                    <div class="card-body">
                        <% if (typeof stats !== 'undefined') { %>
                            <% if (stats.habilitations_a_renouveler > 0) { %>
                            <div class="alert alert-warning">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                        <strong><%= stats.habilitations_a_renouveler %></strong> habilitation(s) à renouveler
                                    </div>
                                    <a href="/rh/habilitations?filter=expiring" class="btn btn-sm btn-warning">
                                        Voir <i class="bi bi-arrow-right ms-1"></i>
                                    </a>
                                </div>
                            </div>
                            <% } %>
                            
                            <% if (stats.besoins_en_attente > 0) { %>
                            <div class="alert alert-info">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-clipboard-check-fill me-2"></i>
                                        <strong><%= stats.besoins_en_attente %></strong> besoin(s) en formation en attente
                                    </div>
                                    <a href="/rh/besoins-formation" class="btn btn-sm btn-info">
                                        Voir <i class="bi bi-arrow-right ms-1"></i>
                                    </a>
                                </div>
                            </div>
                            <% } %>
                            
                            <% if (stats.recrutements_ouverts > 0) { %>
                            <div class="alert alert-primary">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-people-fill me-2"></i>
                                        <strong><%= stats.recrutements_ouverts %></strong> recrutement(s) en cours
                                    </div>
                                    <a href="/rh/recrutements" class="btn btn-sm btn-primary">
                                        Voir <i class="bi bi-arrow-right ms-1"></i>
                                    </a>
                                </div>
                            </div>
                            <% } %>
                            
                            <% if (stats.habilitations_a_renouveler === 0 && stats.besoins_en_attente === 0 && stats.recrutements_ouverts === 0) { %>
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                Aucune action requise pour le moment
                            </div>
                            <% } %>
                        <% } else { %>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                Chargement des alertes...
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>