<!-- ==================== views/rh/postes-list.ejs (CORRIGÉ) ==================== -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Postes - Lab Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        .main-content {
            margin-left: 260px;
            width: calc(100% - 260px);
            padding: 30px;
            min-height: 100vh;
            background-color: #f8f9fa;
        }

        .modal-header-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .info-section {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .info-label {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.1rem;
            color: #212529;
        }

        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-radius: 10px;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }

        .stat-card p {
            margin: 0;
            opacity: 0.9;
        }

        .competence-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin: 5px;
        }

        .personnel-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }

        .page-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="d-flex">
        <%- include('../partials/sidebar') %>
        <link href="/css/global.css" rel="stylesheet">

<!-- Après la sidebar -->
<%- include('../partials/navbar', { 
    pageTitle: 'Gestion des Formations',
    pageSubtitle: 'Planification et suivi',
    pageIcon: 'mortarboard-fill',
    backUrl: '/rh/dashboard',
    username: username
}) %>
        <!-- Main Content -->
        <div class="main-content">
            <div class="container-fluid">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1">
                                <i class="bi bi-briefcase-fill text-primary"></i> 
                                Gestion des Postes / Fonctions
                            </h2>
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb mb-0">
                                    <li class="breadcrumb-item"><a href="/dashboard">Accueil</a></li>
                                    <li class="breadcrumb-item"><a href="/rh/dashboard">RH</a></li>
                                    <li class="breadcrumb-item active">Postes</li>
                                </ol>
                            </nav>
                        </div>
                        <div>
                            <a href="/rh/postes/add" class="btn btn-primary">
                                <i class="bi bi-plus-circle me-2"></i> Créer un Poste
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Statistiques rapides -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-card">
                            <p class="mb-1">Total Postes</p>
                            <h3><%= postes.length %></h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <p class="mb-1">Postes Actifs</p>
                            <h3><%= postes.filter(p => p.statut === 'Actif').length %></h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <p class="mb-1">Postes Vacants</p>
                            <h3><%= postes.reduce((sum, p) => sum + (p.postes_vacants || 0), 0) %></h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                            <p class="mb-1">Postes Occupés</p>
                            <h3><%= postes.reduce((sum, p) => sum + (p.postes_occupes || 0), 0) %></h3>
                        </div>
                    </div>
                </div>

                <!-- Table des postes -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul me-2"></i>
                            Liste des Postes
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="postesTable" class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Titre</th>
                                        <th>Département</th>
                                        <th>Niveau</th>
                                        <th>Disponibles</th>
                                        <th>Occupés</th>
                                        <th>Vacants</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% postes.forEach(poste => { %>
                                    <tr>
                                        <td><strong class="text-primary"><%= poste.code %></strong></td>
                                        <td><%= poste.titre %></td>
                                        <td>
                                            <% if (poste.departement_nom) { %>
                                                <span class="badge bg-secondary">
                                                    <i class="bi bi-building"></i> <%= poste.departement_nom %>
                                                </span>
                                            <% } else { %>
                                                <span class="text-muted">-</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <% 
                                            let niveauClass = 'info';
                                            if (poste.niveau === 'Expert') niveauClass = 'danger';
                                            else if (poste.niveau === 'Senior') niveauClass = 'primary';
                                            else if (poste.niveau === 'Confirmé') niveauClass = 'success';
                                            else if (poste.niveau === 'Junior') niveauClass = 'warning';
                                            %>
                                            <span class="badge bg-<%= niveauClass %>"><%= poste.niveau %></span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-primary"><%= poste.nb_postes_disponibles %></span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success"><%= poste.postes_occupes || 0 %></span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge <%= (poste.postes_vacants || 0) > 0 ? 'bg-warning' : 'bg-secondary' %>">
                                                <%= poste.postes_vacants || 0 %>
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge <%= poste.statut === 'Actif' ? 'bg-success' : 'bg-secondary' %>">
                                                <i class="bi <%= poste.statut === 'Actif' ? 'bi-check-circle' : 'bi-x-circle' %>"></i>
                                                <%= poste.statut %>
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-info" 
                                                        onclick="viewDetails(<%= poste.id %>)"
                                                        title="Voir les détails">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <a href="/rh/postes/edit/<%= poste.id %>" 
                                                   class="btn btn-sm btn-warning"
                                                   title="Modifier">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Détails Poste -->
    <div class="modal fade" id="posteDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header modal-header-custom">
                    <h5 class="modal-title">
                        <i class="bi bi-briefcase-fill me-2"></i>
                        Détails du Poste
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="posteDetailsContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-3 text-muted">Chargement des détails...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i> Fermer
                    </button>
                    <button type="button" class="btn btn-warning" id="btnEditPoste">
                        <i class="bi bi-pencil"></i> Modifier
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        let currentPosteId = null;

        // Initialisation DataTable
        $(document).ready(function() {
            $('#postesTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json',
                    search: "Rechercher :",
                    lengthMenu: "Afficher _MENU_ entrées",
                    info: "Affichage de _START_ à _END_ sur _TOTAL_ entrées",
                    infoEmpty: "Aucune entrée disponible",
                    infoFiltered: "(filtré de _MAX_ entrées au total)",
                    zeroRecords: "Aucun résultat trouvé",
                    paginate: {
                        first: "Premier",
                        last: "Dernier",
                        next: "Suivant",
                        previous: "Précédent"
                    }
                },
                order: [[1, 'asc']],
                pageLength: 25,
                responsive: true
            });
        });

        // Fonction pour afficher les détails d'un poste
        async function viewDetails(id) {
            currentPosteId = id;
            const modal = new bootstrap.Modal(document.getElementById('posteDetailsModal'));
            modal.show();

            // Réinitialiser le contenu
            document.getElementById('posteDetailsContent').innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-3 text-muted">Chargement des détails...</p>
                </div>
            `;

            try {
                console.log('Chargement des détails du poste:', id);
                const response = await fetch(`/rh/postes/api/${id}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Données reçues:', data);

                if (data.success) {
                    displayPosteDetails(data.poste, data.personnel, data.competences);
                } else {
                    showError(data.message || 'Impossible de charger les détails du poste');
                }
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                showError('Erreur lors du chargement des détails: ' + error.message);
            }
        }

        // Fonction pour afficher les détails
        function displayPosteDetails(poste, personnel, competences) {
            const content = `
                <div class="row">
                    <!-- Colonne gauche - Informations générales -->
                    <div class="col-md-6">
                        <h5 class="mb-3 text-primary">
                            <i class="bi bi-info-circle-fill"></i> Informations Générales
                        </h5>
                        
                        <div class="info-section">
                            <div class="info-label">Code du Poste</div>
                            <div class="info-value">
                                <span class="badge bg-primary fs-6">${poste.code}</span>
                            </div>
                        </div>

                        <div class="info-section">
                            <div class="info-label">Titre du Poste</div>
                            <div class="info-value">
                                <strong>${poste.titre}</strong>
                            </div>
                        </div>

                        <div class="info-section">
                            <div class="info-label">Département</div>
                            <div class="info-value">
                                ${poste.departement_nom ? 
                                    `<i class="bi bi-building text-primary"></i> ${poste.departement_nom}` : 
                                    '<span class="text-muted">Non assigné</span>'}
                            </div>
                        </div>

                        <div class="info-section">
                            <div class="info-label">Niveau Requis</div>
                            <div class="info-value">
                                <span class="badge bg-info fs-6">${poste.niveau}</span>
                            </div>
                        </div>

                        <div class="info-section">
                            <div class="info-label">Statut</div>
                            <div class="info-value">
                                <span class="badge ${poste.statut === 'Actif' ? 'bg-success' : 'bg-secondary'} fs-6">
                                    <i class="bi ${poste.statut === 'Actif' ? 'bi-check-circle' : 'bi-x-circle'}"></i>
                                    ${poste.statut}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Colonne droite - Statistiques -->
                    <div class="col-md-6">
                        <h5 class="mb-3 text-primary">
                            <i class="bi bi-bar-chart-fill"></i> Statistiques
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="info-section text-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                    <div class="info-label" style="color: rgba(255,255,255,0.9);">Postes Disponibles</div>
                                    <div class="info-value">
                                        <h2 class="mb-0" style="color: white;">${poste.nb_postes_disponibles}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="info-section text-center" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                                    <div class="info-label" style="color: rgba(255,255,255,0.9);">Occupés</div>
                                    <div class="info-value">
                                        <h3 class="mb-0" style="color: white;">${poste.postes_occupes || 0}</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="info-section text-center" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                                    <div class="info-label" style="color: rgba(255,255,255,0.9);">Vacants</div>
                                    <div class="info-value">
                                        <h3 class="mb-0" style="color: white;">${poste.postes_vacants || 0}</h3>
                                    </div>
                                </div>
                            </div>
                        </div>

                        ${poste.created_at ? `
                        <div class="info-section mt-3">
                            <div class="info-label">Date de Création</div>
                            <div class="info-value">
                                <i class="bi bi-calendar-check"></i> 
                                ${new Date(poste.created_at).toLocaleDateString('fr-FR', { 
                                    day: 'numeric', 
                                    month: 'long', 
                                    year: 'numeric' 
                                })}
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Description du poste -->
                ${poste.description ? `
                <div class="mt-4">
                    <h5 class="mb-3 text-primary">
                        <i class="bi bi-file-text-fill"></i> Description du Poste
                    </h5>
                    <div class="info-section">
                        <div class="info-value">${poste.description.replace(/\n/g, '<br>')}</div>
                    </div>
                </div>
                ` : ''}

                <!-- Compétences requises -->
                <div class="mt-4">
                    <h5 class="mb-3 text-primary">
                        <i class="bi bi-star-fill"></i> 
                        Compétences Requises 
                        ${competences && competences.length > 0 ? `<span class="badge bg-primary">${competences.length}</span>` : ''}
                    </h5>
                    
                    ${competences && competences.length > 0 ? `
                    <div class="row g-3">
                        ${competences.map(comp => `
                            <div class="col-md-6">
                                <div class="competence-badge">
                                    <i class="bi bi-star-fill me-2"></i>
                                    <strong>${comp.nom}</strong>
                                    ${comp.categorie ? `<br><small style="opacity: 0.8;">${comp.categorie}</small>` : ''}
                                    ${comp.niveau_requis ? `
                                        <span class="badge bg-light text-dark ms-2">
                                            Niveau: ${comp.niveau_requis}
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ` : poste.competences_requises ? `
                    <div class="info-section">
                        <div class="info-value">${poste.competences_requises}</div>
                    </div>
                    ` : `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Aucune compétence spécifique requise pour ce poste
                    </div>
                    `}
                </div>

                <!-- Personnel affecté -->
                <div class="mt-4">
                    <h5 class="mb-3 text-primary">
                        <i class="bi bi-people-fill"></i> 
                        Personnel Affecté 
                        ${personnel && personnel.length > 0 ? `<span class="badge bg-success">${personnel.length}</span>` : ''}
                    </h5>
                    
                    ${personnel && personnel.length > 0 ? `
                    <div class="personnel-table">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Matricule</th>
                                    <th>Nom Complet</th>
                                    <th>Type</th>
                                    <th>Date Début</th>
                                    <th>Date Fin</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${personnel.map(p => `
                                    <tr>
                                        <td>
                                            <strong class="text-primary">${p.matricule}</strong>
                                        </td>
                                        <td>
                                            <i class="bi bi-person-fill text-muted"></i>
                                            ${p.prenom} ${p.nom}
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">${p.type_personnel}</span>
                                        </td>
                                        <td>
                                            ${p.date_debut ? 
                                                `<i class="bi bi-calendar-check text-success"></i> ${new Date(p.date_debut).toLocaleDateString('fr-FR')}` : 
                                                '<span class="text-muted">-</span>'}
                                        </td>
                                        <td>
                                            ${p.date_fin ? 
                                                `<i class="bi bi-calendar-x text-danger"></i> ${new Date(p.date_fin).toLocaleDateString('fr-FR')}` : 
                                                '<span class="text-muted">-</span>'}
                                        </td>
                                        <td>
                                            <span class="badge ${p.statut_affectation === 'En cours' ? 'bg-success' : 'bg-secondary'}">
                                                <i class="bi ${p.statut_affectation === 'En cours' ? 'bi-check-circle' : 'bi-x-circle'}"></i>
                                                ${p.statut_affectation || 'En cours'}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        Aucun personnel actuellement affecté à ce poste
                    </div>
                    `}
                </div>
            `;

            document.getElementById('posteDetailsContent').innerHTML = content;
        }

        // Fonction pour afficher les erreurs
        function showError(message) {
            document.getElementById('posteDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>Erreur :</strong> ${message}
                </div>
            `;
        }

        // Bouton modifier dans la modal
        document.getElementById('btnEditPoste').addEventListener('click', function() {
            if (currentPosteId) {
                window.location.href = `/rh/postes/edit/${currentPosteId}`;
            }
        });

        // Gestion des messages de succès/erreur
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');
            const error = urlParams.get('error');

            if (success) {
                showToast('Succès', success, 'success');
            }
            if (error) {
                showToast('Erreur', error, 'danger');
            }
        });

        // Fonction pour afficher les toasts
        function showToast(title, message, type) {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}:</strong> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            // Créer le conteneur de toast s'il n'existe pas
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            // Supprimer le toast après qu'il soit caché
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
    </script>
</body>
</html>