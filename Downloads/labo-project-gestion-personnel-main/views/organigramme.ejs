<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organigramme Dynamique</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: #f5f7fa; }
        .org-chart { padding: 20px; overflow-x: auto; }
        .org-level { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; margin: 20px 0; }
        
        .org-node {
            background: white;
            border: 3px solid #6c5b7b;
            border-radius: 12px;
            padding: 20px;
            min-width: 220px;
            max-width: 280px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .org-node:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            border-color: #8b7a9b;
        }
        
        .org-node.dcgs {
            background: linear-gradient(135deg, #6c5b7b 0%, #8b7a9b 100%);
            color: white;
            border: none;
            font-size: 1.2rem;
            padding: 30px;
        }
        
        .org-node.biologiste {
            background: linear-gradient(135deg, #9a88ab 0%, #b8a8c8 100%);
            color: white;
            border-color: #6c5b7b;
        }
        
        .org-node.cadre {
            background: linear-gradient(135deg, #00bfa5 0%, #1de9b6 100%);
            color: white;
            border-color: #00a38f;
        }
        
        .org-node.technicien {
            background: linear-gradient(135deg, #8b9556 0%, #a5b168 100%);
            color: white;
            border-color: #7a8347;
        }
        
        .org-node.support {
            background: linear-gradient(135deg, #78909c 0%, #90a4ae 100%);
            color: white;
            border-color: #607d8b;
        }
        
        .badge-count {
            position: absolute;
            top: -12px;
            right: -12px;
            background: #ff5252;
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .org-connector {
            width: 3px;
            height: 40px;
            background: linear-gradient(to bottom, #6c5b7b, #ddd);
            margin: 0 auto;
        }
        
        .department-section {
            border: 3px dashed #e0e0e0;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
        }
        
        .department-title {
            background: white;
            border: 2px solid #6c5b7b;
            border-radius: 10px;
            padding: 15px 30px;
            display: inline-block;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .person-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        
        .person-name {
            font-size: 0.9rem;
            font-weight: 600;
            margin: 5px 0;
        }
        
        .person-contact {
            font-size: 0.75rem;
            opacity: 0.9;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 50px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        @media print {
            .no-print { display: none !important; }
            .org-node { break-inside: avoid; page-break-inside: avoid; }
            body { background: white; }
        }
    </style>
       <style>
        :root {
            --sidebar-width: 250px;
        }
        
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 30px;
            min-height: 100vh;
            background-color: #f8f9fa;
        }

       
    </style>
</head>
<body>
    <%- include('partials/sidebar', { currentPage: 'organigramme' }) %>
    <link href="/css/global.css" rel="stylesheet">

<!-- Après la sidebar -->
<%- include('partials/navbar', { 
    pageTitle: 'Gestion des Formations',
    pageSubtitle: 'Planification et suivi',
    pageIcon: 'mortarboard-fill',
    backUrl: '/rh/dashboard',
    username: username
}) %>
 <div class="main-content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-10 offset-md-2 px-4 py-4">
                <div class="d-flex justify-content-between align-items-center mb-4 no-print">
                    <div>
                        <h2><i class="bi bi-diagram-3 text-primary"></i> Organigramme Dynamique</h2>
                        <p class="text-muted mb-0">Structure hiérarchique mise à jour en temps réel</p>
                    </div>
                    <div>
                        <button class="btn btn-outline-primary me-2" onclick="toggleNames()">
                            <i class="bi bi-eye me-2"></i> <span id="toggleText">Afficher Noms</span>
                        </button>
                        <button class="btn btn-success me-2" onclick="window.print()">
                            <i class="bi bi-printer me-2"></i> Imprimer
                        </button>
                        <button class="btn btn-info" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise me-2"></i> Actualiser
                        </button>
                    </div>
                </div>

                <!-- Zone de chargement -->
                <div id="loadingArea" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-3 text-muted">Chargement de l'organigramme...</p>
                </div>

                <!-- Contenu de l'organigramme -->
                <div id="orgContent" style="display: none;">
                    <!-- Direction -->
                    <div id="directionSection" class="text-center mb-4"></div>
                    <div class="org-connector"></div>

                    <!-- Responsables -->
                    <div class="department-section">
                        <div class="text-center">
                            <div class="department-title">
                                <h5 class="mb-0"><i class="bi bi-shield-check text-primary me-2"></i>Direction et Responsabilités</h5>
                            </div>
                        </div>
                        <div id="responsablesSection" class="org-level"></div>
                    </div>
                    <div class="org-connector"></div>

                    <!-- Biologistes -->
                    <div class="department-section">
                        <div class="text-center">
                            <div class="department-title">
                                <h5 class="mb-0"><i class="bi bi-mortarboard text-primary me-2"></i>Départements - BIOLOGISTES</h5>
                            </div>
                        </div>
                        <div id="biologistesSection" class="org-level"></div>
                    </div>

                    <!-- Techniciens -->
                    <div class="department-section">
                        <div class="text-center">
                            <div class="department-title">
                                <h5 class="mb-0"><i class="bi bi-tools text-success me-2"></i>Personnel Technique - TECHNICIENS</h5>
                            </div>
                        </div>
                        <div id="techniciensSection" class="org-level"></div>
                        <div id="gardeNuitSection" class="org-level justify-content-center mt-4"></div>
                    </div>

                    <!-- Support -->
                    <div class="department-section">
                        <div class="text-center">
                            <div class="department-title">
                                <h5 class="mb-0"><i class="bi bi-people text-info me-2"></i>Personnel de Support</h5>
                            </div>
                        </div>
                        <div id="supportSection" class="org-level"></div>
                    </div>

                    <!-- Statistiques -->
                    <div class="card mt-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Statistiques en Temps Réel</h5>
                        </div>
                        <div class="card-body">
                            <div class="row" id="statsSection"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Détails -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">Personnel</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalContent"></div>
            </div>
        </div>
    </div>
 </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let orgData = null;
        let showNames = false;

        // Charger les données
        async function loadOrgData() {
            try {
                $('#loadingArea').show();
                $('#orgContent').hide();
                
                const response = await fetch('/organigramme/api/data');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                orgData = await response.json();
                
                console.log('Données chargées:', orgData);
                
                renderOrgChart();
                
                $('#loadingArea').hide();
                $('#orgContent').show();
            } catch (err) {
                console.error('Erreur:', err);
                $('#loadingArea').html(`
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Erreur lors du chargement:</strong> ${err.message}
                        <br><small>Vérifiez que la base de données contient des données et que toutes les tables nécessaires existent.</small>
                    </div>
                `);
            }
        }

        // Rendre l'organigramme complet
        function renderOrgChart() {
            renderDirection();
            renderResponsables();
            renderBiologistes();
            renderTechniciens();
            renderSupport();
            renderStatistics();
        }

        // Rendre la direction
        function renderDirection() {
            const dir = orgData.direction;
            let html = '';
            
            if (dir) {
                html = `
                    <div class="org-node dcgs d-inline-block" onclick="showPersonDetails(${dir.id})">
                        <i class="bi bi-building fs-1 mb-2"></i>
                        <h4 class="mb-1">DCGS</h4>
                        <small>Direction Contrôle & Gestion Sanitaire</small>
                        <div class="person-info ${showNames ? '' : 'd-none'}" data-names="true">
                            <div class="person-name">${dir.nom_complet}</div>
                            <div class="person-contact">${dir.email}</div>
                        </div>
                    </div>
                `;
            } else {
                html = `
                    <div class="empty-state">
                        <i class="bi bi-building"></i>
                        <p>Aucun directeur DCGS défini dans la base de données.</p>
                        <small class="text-muted">Veuillez créer un cadre avec un poste contenant "Directeur" ou "DCGS"</small>
                    </div>
                `;
            }
            
            $('#directionSection').html(html);
        }

        // Rendre les responsables
        function renderResponsables() {
            let html = '';
            
            if (orgData.responsables && orgData.responsables.length > 0) {
                orgData.responsables.forEach(resp => {
                    const icon = resp.type_personnel === 'Biologiste' ? 'mortarboard' : 'shield-check';
                    const classe = resp.type_personnel === 'Biologiste' ? 'biologiste' : 'cadre';
                    
                    html += `
                        <div class="org-node ${classe}" onclick="showPersonDetails(${resp.id})">
                            <i class="bi bi-${icon} fs-2"></i>
                            <h6 class="mt-2">${resp.role || resp.departement || 'Responsable'}</h6>
                            <small>${resp.type_personnel}</small>
                            <div class="person-info ${showNames ? '' : 'd-none'}" data-names="true">
                                <div class="person-name">${resp.nom_complet}</div>
                                <div class="person-contact">${resp.email}</div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html = `
                    <div class="empty-state">
                        <i class="bi bi-people"></i>
                        <p>Aucun responsable défini.</p>
                        <small class="text-muted">Créez des cadres avec des postes "Responsable" ou "Chef", ou des biologistes avec responsabilité AQ</small>
                    </div>
                `;
            }
            
            $('#responsablesSection').html(html);
        }

        // Rendre les biologistes
        function renderBiologistes() {
            let html = '';
            
            if (orgData.biologistes && orgData.biologistes.parSpecialite) {
                const specialites = Object.keys(orgData.biologistes.parSpecialite);
                
                if (specialites.length > 0) {
                    specialites.forEach(spec => {
                        const count = orgData.biologistes.parSpecialite[spec].length;
                        const iconMap = {
                            'Biologie Délocalisée': 'lightning-charge',
                            'Biochimie': 'droplet',
                            'Hématologie Hémostase': 'heart-pulse',
                            'Microbiologie': 'virus',
                            'Immuno-Séro-Electro': 'shield-plus',
                            'Immuno-Hémato': 'droplet-half'
                        };
                        const icon = iconMap[spec] || 'mortarboard';
                        
                        html += `
                            <div class="org-node biologiste" onclick="showNodePersonnel('biologiste', '${spec}')">
                                <i class="bi bi-${icon} fs-2"></i>
                                <h6 class="mt-2">${spec}</h6>
                                <small>${count} biologiste${count > 1 ? 's' : ''}</small>
                                <span class="badge-count">${count}</span>
                            </div>
                        `;
                    });
                } else {
                    html = `
                        <div class="empty-state">
                            <i class="bi bi-mortarboard"></i>
                            <p>Aucun biologiste avec spécialité définie.</p>
                            <small class="text-muted">Ajoutez des biologistes avec leurs spécialités dans la table Biologistes</small>
                        </div>
                    `;
                }
            } else {
                html = `
                    <div class="empty-state">
                        <i class="bi bi-mortarboard"></i>
                        <p>Aucun biologiste enregistré.</p>
                        <small class="text-muted">Créez du personnel de type "Biologiste" avec leurs spécialités</small>
                    </div>
                `;
            }
            
            $('#biologistesSection').html(html);
        }

        // Rendre les techniciens
        function renderTechniciens() {
            let html = '';
            
            if (orgData.techniciens && orgData.techniciens.parDepartement) {
                const depts = Object.keys(orgData.techniciens.parDepartement);
                
                if (depts.length > 0) {
                    depts.forEach(dept => {
                        const count = orgData.techniciens.parDepartement[dept].length;
                        
                        html += `
                            <div class="org-node technicien" onclick="showNodePersonnel('technicien', '${dept}')">
                                <i class="bi bi-gear fs-2"></i>
                                <h6 class="mt-2">Tech. ${dept}</h6>
                                <small>${count} technicien${count > 1 ? 's' : ''}</small>
                                <span class="badge-count">${count}</span>
                            </div>
                        `;
                    });
                } else {
                    html = `
                        <div class="empty-state">
                            <i class="bi bi-tools"></i>
                            <p>Aucun technicien avec département défini.</p>
                            <small class="text-muted">Ajoutez des techniciens avec leurs départements dans la table Techniciens</small>
                        </div>
                    `;
                }
            } else {
                html = `
                    <div class="empty-state">
                        <i class="bi bi-tools"></i>
                        <p>Aucun technicien enregistré.</p>
                        <small class="text-muted">Créez du personnel de type "Technicien" avec leurs départements</small>
                    </div>
                `;
            }
            
            $('#techniciensSection').html(html);
            
            // Garde de nuit
            if (orgData.techniciens && orgData.techniciens.gardeNuit) {
                const gardeCount = orgData.techniciens.gardeNuit.length;
                if (gardeCount > 0) {
                    $('#gardeNuitSection').html(`
                        <div class="org-node technicien" onclick="showNodePersonnel('technicien', 'Garde de Nuit')">
                            <i class="bi bi-moon-stars fs-2"></i>
                            <h6 class="mt-2">Garde de Nuit</h6>
                            <small>Personnel 24/7</small>
                            <span class="badge-count">${gardeCount}</span>
                        </div>
                    `);
                } else {
                    $('#gardeNuitSection').html('');
                }
            } else {
                $('#gardeNuitSection').html('');
            }
        }

        // Rendre le support
        function renderSupport() {
            let html = '';
            
            if (orgData.support) {
                const secretaires = orgData.support.secretaires ? orgData.support.secretaires.length : 0;
                const preleveurs = orgData.support.preleveurs ? orgData.support.preleveurs.length : 0;
                const agents = orgData.support.agents ? orgData.support.agents.length : 0;
                
                if (secretaires > 0 || preleveurs > 0 || agents > 0) {
                    if (secretaires > 0) {
                        html += `
                            <div class="org-node support" onclick="showNodePersonnel('support', 'Secrétaire')">
                                <i class="bi bi-person-workspace fs-2"></i>
                                <h6 class="mt-2">Secrétaires</h6>
                                <small>Administration & Accueil</small>
                                <span class="badge-count">${secretaires}</span>
                            </div>
                        `;
                    }
                    if (preleveurs > 0) {
                        html += `
                            <div class="org-node support" onclick="showNodePersonnel('support', 'Préleveur')">
                                <i class="bi bi-droplet-half fs-2"></i>
                                <h6 class="mt-2">Préleveurs</h6>
                                <small>Prélèvements</small>
                                <span class="badge-count">${preleveurs}</span>
                            </div>
                        `;
                    }
                    if (agents > 0) {
                        html += `
                            <div class="org-node support" onclick="showNodePersonnel('support', 'Agent Logistique')">
                                <i class="bi bi-box-seam fs-2"></i>
                                <h6 class="mt-2">Agents Logistiques</h6>
                                <small>Logistique & Support</small>
                                <span class="badge-count">${agents}</span>
                            </div>
                        `;
                    }
                } else {
                    html = `
                        <div class="empty-state">
                            <i class="bi bi-people"></i>
                            <p>Aucun personnel de support enregistré.</p>
                            <small class="text-muted">Créez du personnel de type "Secrétaire", "Préleveur" ou "Agent Logistique"</small>
                        </div>
                    `;
                }
            } else {
                html = `
                    <div class="empty-state">
                        <i class="bi bi-people"></i>
                        <p>Aucun personnel de support enregistré.</p>
                    </div>
                `;
            }
            
            $('#supportSection').html(html);
        }

        // Rendre les statistiques
        function renderStatistics() {
            let html = '';
            
            if (orgData.statistiques && orgData.statistiques.parType) {
                html = '<div class="col-md-8"><h6>Répartition par Type de Personnel</h6><table class="table table-sm table-striped">';
                html += '<thead><tr><th>Type</th><th class="text-end">Effectif Actif</th></tr></thead><tbody>';
                
                orgData.statistiques.parType.forEach(s => {
                    html += `<tr><td><i class="bi bi-circle-fill me-2" style="color: #6c5b7b; font-size: 0.5rem;"></i>${s.type_personnel}</td><td class="text-end"><span class="badge bg-primary">${s.actifs || 0}</span></td></tr>`;
                });
                
                const total = orgData.statistiques.total || 0;
                html += `</tbody><tfoot><tr class="fw-bold"><td>TOTAL</td><td class="text-end"><span class="badge bg-success">${total}</span></td></tr></tfoot></table></div>`;
                html += `<div class="col-md-4 text-center"><h6>Total Personnel Actif</h6><h1 class="display-3 text-primary fw-bold">${total}</h1><p class="text-muted">Collaborateurs</p></div>`;
            } else {
                html = '<div class="col-12"><div class="empty-state"><i class="bi bi-bar-chart"></i><p>Statistiques non disponibles</p></div></div>';
            }
            
            $('#statsSection').html(html);
        }

        // Afficher le personnel d'un nœud
        async function showNodePersonnel(type, category) {
            try {
                const response = await fetch(`/organigramme/api/node/${type}/${encodeURIComponent(category)}`);
                const personnel = await response.json();
                
                displayPersonnelModal(personnel, category);
            } catch (err) {
                alert('Erreur: ' + err.message);
            }
        }

        // Afficher modal avec liste du personnel
        function displayPersonnelModal(personnel, title) {
            $('#modalTitle').html(`<i class="bi bi-people me-2"></i>${title} (${personnel.length})`);
            
            let html = '<div class="table-responsive"><table class="table table-hover"><thead><tr>';
            html += '<th>Matricule</th><th>Nom</th><th>Email</th><th>Téléphone</th><th>Actions</th></tr></thead><tbody>';
            
            if (personnel.length > 0) {
                personnel.forEach(p => {
                    html += `<tr>
                        <td><span class="badge bg-secondary">${p.matricule}</span></td>
                        <td><i class="bi bi-person-circle me-2"></i>${p.nom_complet}</td>
                        <td><small><i class="bi bi-envelope me-1"></i>${p.email}</small></td>
                        <td><small><i class="bi bi-telephone me-1"></i>${p.telephone || 'N/A'}</small></td>
                        <td><a href="/personnel/edit/${p.id}" class="btn btn-sm btn-primary"><i class="bi bi-eye"></i> Voir</a></td>
                    </tr>`;
                });
            } else {
                html += '<tr><td colspan="5" class="text-center text-muted">Aucun personnel dans cette catégorie</td></tr>';
            }
            
            html += '</tbody></table></div>';
            $('#modalContent').html(html);
            $('#detailsModal').modal('show');
        }

        // Afficher détails d'une personne
        function showPersonDetails(id) {
            window.location.href = `/personnel/edit/${id}`;
        }

        // Toggle noms
        function toggleNames() {
            showNames = !showNames;
            $('[data-names="true"]').toggleClass('d-none');
            $('#toggleText').text(showNames ? 'Masquer Noms' : 'Afficher Noms');
        }

        // Actualiser
        function refreshData() {
            loadOrgData();
        }

        // Initialisation
        $(document).ready(() => loadOrgData());
    </script>
</body>
</html>